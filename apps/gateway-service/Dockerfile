# This file is generated by Nx.
#
# Build the docker image with `npx nx docker-build backend`.
# Tip: Modify "docker-build" options in project.json to change docker build args.
#
# Run the container with `docker run -p 3000:3000 -t backend`.

FROM docker.io/node:lts-alpine

ARG SERVICE_VERSION
# Set environment variables
ENV HOST=0.0.0.0
ENV PORT=3000
ENV NODE_ENV=production
ENV SERVICE_VERSION=${SERVICE_VERSION}

# Set the working directory
WORKDIR /app

# Install bash, curl, corepack and pnpm
RUN apk add --no-cache bash curl && \
    npm install -g corepack && \
    corepack enable && \
    corepack prepare pnpm@latest --activate && \
    pnpm --version

# Add user and group for backend
RUN addgroup --system backend && \
    adduser --system -G backend backend

# Copy the dist folder to the container
COPY dist/apps/backend backend/

# Install dependencies using pnpm
RUN cd backend && \
    pnpm install --frozen-lockfile --prod && \
    pnpm store prune

# Ensure the backend directory has the right ownership
RUN chown -R backend:backend /app

# Switch to the backend user
USER backend

# Expose port
EXPOSE 3000

# Command to run the backend
CMD [ "node", "backend" ]
